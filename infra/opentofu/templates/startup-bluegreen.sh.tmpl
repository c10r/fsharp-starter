#!/usr/bin/env bash
set -euo pipefail

export DEBIAN_FRONTEND=noninteractive

apt-get update
apt-get install -y ca-certificates curl gnupg lsb-release apt-transport-https docker.io
apt-get install -y docker-compose-plugin || apt-get install -y docker-compose-v2 || apt-get install -y docker-compose

if ! command -v gcloud >/dev/null 2>&1; then
  install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | gpg --dearmor -o /etc/apt/keyrings/google-cloud.gpg
  chmod a+r /etc/apt/keyrings/google-cloud.gpg
  echo "deb [signed-by=/etc/apt/keyrings/google-cloud.gpg] https://packages.cloud.google.com/apt cloud-sdk main" > /etc/apt/sources.list.d/google-cloud-sdk.list
  apt-get update
  apt-get install -y google-cloud-cli
fi

systemctl enable docker
systemctl start docker

mkdir -p /opt/fsharp-starter

DATA_DISK_DEVICE="/dev/disk/by-id/google-${data_disk_name}"
DATA_MOUNT_PATH="${data_mount_path}"

for _ in $(seq 1 30); do
  if [[ -b "$${DATA_DISK_DEVICE}" ]]; then
    break
  fi
  sleep 2
done

if [[ ! -b "$${DATA_DISK_DEVICE}" ]]; then
  echo "Data disk not found at $${DATA_DISK_DEVICE}" >&2
  exit 1
fi

mkdir -p "$${DATA_MOUNT_PATH}"

if ! blkid "$${DATA_DISK_DEVICE}" >/dev/null 2>&1; then
  mkfs.ext4 -F "$${DATA_DISK_DEVICE}"
fi

DATA_DISK_UUID="$(blkid -s UUID -o value "$${DATA_DISK_DEVICE}")"
if ! grep -q "$${DATA_DISK_UUID}" /etc/fstab; then
  echo "UUID=$${DATA_DISK_UUID} $${DATA_MOUNT_PATH} ext4 defaults,nofail,discard 0 2" >> /etc/fstab
fi

if ! mountpoint -q "$${DATA_MOUNT_PATH}"; then
  mount "$${DATA_MOUNT_PATH}"
fi

mkdir -p "$${DATA_MOUNT_PATH}/fsharp-starter-db" "$${DATA_MOUNT_PATH}/openfga"
chmod 0777 "$${DATA_MOUNT_PATH}/fsharp-starter-db" "$${DATA_MOUNT_PATH}/openfga"

GOOGLE_DIRECTORY_CREDENTIALS_SECRET_NAME="${google_directory_credentials_secret_name}"
GOOGLE_DIRECTORY_CREDENTIALS_PATH=""

mkdir -p /opt/fsharp-starter/creds
if [[ -n "$${GOOGLE_DIRECTORY_CREDENTIALS_SECRET_NAME}" ]]; then
  GOOGLE_DIRECTORY_CREDENTIALS_PATH="/var/secrets/google/directory-dwd-key.json"
  gcloud secrets versions access latest \
    --secret "$${GOOGLE_DIRECTORY_CREDENTIALS_SECRET_NAME}" \
    --project "${project_id}" \
    > /opt/fsharp-starter/creds/directory-dwd-key.json
  chmod 600 /opt/fsharp-starter/creds/directory-dwd-key.json
fi

cat > /opt/fsharp-starter/docker-compose.gce.yml <<'COMPOSE'
services:
  fsharp-starter-api:
    image: $${FSHARP_STARTER_IMAGE}
    container_name: fsharp-starter-api
    ports:
      - "8080:8080"
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ConnectionStrings__DefaultConnection: Data Source=/app/data/fsharp-starter.db
      OpenFGA__ApiUrl: http://openfga:8090
      OpenFGA__OrgAdminEmail: $${FSHARP_STARTER_ORG_ADMIN_EMAIL}
      Auth__IAP__ValidateJwt: "$${FSHARP_STARTER_VALIDATE_IAP_JWT}"
      Auth__IAP__JwtAudience: $${FSHARP_STARTER_IAP_JWT_AUDIENCE}
      Auth__GoogleDirectory__Enabled: "$${FSHARP_STARTER_GOOGLE_DIRECTORY_ENABLED}"
      Auth__GoogleDirectory__AdminUserEmail: $${FSHARP_STARTER_GOOGLE_DIRECTORY_ADMIN_USER_EMAIL}
      Auth__GoogleDirectory__Scope: $${FSHARP_STARTER_GOOGLE_DIRECTORY_SCOPE}
      Auth__GoogleDirectory__OrgUnitKeyPrefix: $${FSHARP_STARTER_GOOGLE_DIRECTORY_OU_KEY_PREFIX}
      Auth__GoogleDirectory__IncludeOrgUnitHierarchy: "$${FSHARP_STARTER_GOOGLE_DIRECTORY_INCLUDE_OU_HIERARCHY}"
      Auth__GoogleDirectory__CustomAttributeKeyPrefix: $${FSHARP_STARTER_GOOGLE_DIRECTORY_CUSTOM_KEY_PREFIX}
      Auth__GoogleDirectory__CredentialsFile: $${FSHARP_STARTER_GOOGLE_DIRECTORY_CREDENTIALS_FILE}
    volumes:
      - $${FSHARP_STARTER_DATA_ROOT}/fsharp-starter-db:/app/data
      - /opt/fsharp-starter/creds:/var/secrets/google:ro
    restart: unless-stopped
    depends_on:
      - openfga

  openfga-migrate:
    image: openfga/openfga:latest
    container_name: openfga-migrate
    command: migrate
    user: nonroot
    environment:
      OPENFGA_DATASTORE_ENGINE: sqlite
      OPENFGA_DATASTORE_URI: file:/home/nonroot/openfga.db
    volumes:
      - $${FSHARP_STARTER_DATA_ROOT}/openfga:/home/nonroot

  openfga:
    image: openfga/openfga:latest
    container_name: openfga
    command: run
    user: nonroot
    environment:
      OPENFGA_DATASTORE_ENGINE: sqlite
      OPENFGA_DATASTORE_URI: file:/home/nonroot/openfga.db
      OPENFGA_LOG_FORMAT: json
      OPENFGA_HTTP_ADDR: 0.0.0.0:8090
      OPENFGA_GRPC_ADDR: 0.0.0.0:8091
    volumes:
      - $${FSHARP_STARTER_DATA_ROOT}/openfga:/home/nonroot
    restart: unless-stopped
    depends_on:
      openfga-migrate:
        condition: service_completed_successfully
COMPOSE

cat > /opt/fsharp-starter/.env <<ENVFILE
FSHARP_STARTER_IMAGE=${artifact_registry_location}-docker.pkg.dev/${project_id}/${artifact_registry_repo}/${image_name}:${image_tag}
FSHARP_STARTER_IAP_JWT_AUDIENCE=${iap_jwt_audience}
FSHARP_STARTER_GOOGLE_DIRECTORY_ENABLED=${google_directory_enabled}
FSHARP_STARTER_GOOGLE_DIRECTORY_ADMIN_USER_EMAIL=${google_directory_admin_user_email}
FSHARP_STARTER_GOOGLE_DIRECTORY_SCOPE=${google_directory_scope}
FSHARP_STARTER_GOOGLE_DIRECTORY_OU_KEY_PREFIX=${google_directory_org_unit_key_prefix}
FSHARP_STARTER_GOOGLE_DIRECTORY_INCLUDE_OU_HIERARCHY=${google_directory_include_org_unit_hierarchy}
FSHARP_STARTER_GOOGLE_DIRECTORY_CUSTOM_KEY_PREFIX=${google_directory_custom_attribute_key_prefix}
FSHARP_STARTER_GOOGLE_DIRECTORY_CREDENTIALS_FILE=$${GOOGLE_DIRECTORY_CREDENTIALS_PATH}
FSHARP_STARTER_ORG_ADMIN_EMAIL=${org_admin_email}
FSHARP_STARTER_VALIDATE_IAP_JWT=${validate_iap_jwt}
FSHARP_STARTER_DATA_ROOT=${data_mount_path}
ENVFILE

cat > /opt/fsharp-starter/docker-registry-login.sh <<LOGIN
#!/usr/bin/env bash
set -euo pipefail

curl -fsS -H "Metadata-Flavor: Google" \
  "http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token" \
  | python3 -c 'import json,sys; print(json.load(sys.stdin)["access_token"])' \
  | /usr/bin/docker login -u oauth2accesstoken --password-stdin https://${artifact_registry_location}-docker.pkg.dev
LOGIN

chmod 0755 /opt/fsharp-starter/docker-registry-login.sh

cat > /etc/systemd/system/fsharp-starter-compose.service <<'UNIT'
[Unit]
Description=FsharpStarter Docker Compose stack
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/opt/fsharp-starter
ExecStartPre=/opt/fsharp-starter/docker-registry-login.sh
ExecStartPre=/bin/bash -lc 'if /usr/bin/docker compose version >/dev/null 2>&1; then /usr/bin/docker compose -f docker-compose.gce.yml --env-file .env pull; else /usr/bin/docker-compose -f docker-compose.gce.yml --env-file .env pull; fi'
ExecStart=/bin/bash -lc 'if /usr/bin/docker compose version >/dev/null 2>&1; then /usr/bin/docker compose -f docker-compose.gce.yml --env-file .env up -d --remove-orphans; else /usr/bin/docker-compose -f docker-compose.gce.yml --env-file .env up -d --remove-orphans; fi'
ExecStop=/bin/bash -lc 'if /usr/bin/docker compose version >/dev/null 2>&1; then /usr/bin/docker compose -f docker-compose.gce.yml --env-file .env down; else /usr/bin/docker-compose -f docker-compose.gce.yml --env-file .env down; fi'
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable fsharp-starter-compose.service
systemctl start fsharp-starter-compose.service
